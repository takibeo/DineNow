@model IEnumerable<DoAnChuyenNganh.Models.Restaurant>
@{
    ViewData["Title"] = "Trang chủ";
}

<!-- Hero Carousel -->
<div id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <div class="hero-banner" style="background-image: url('/images/hero1.jpg');">
                <div class="hero-content">
                    <h1>Chọn nhà hàng yêu thích của bạn</h1>
                    <p>Đặt bàn nhanh chóng, dễ dàng mọi lúc mọi nơi</p>
                    <button class="btn btn-primary btn-lg btn-scroll" data-target="restaurantsSection">Khám phá ngay</button>
                </div>
            </div>
        </div>
        <div class="carousel-item">
            <div class="hero-banner" style="background-image: url('/images/hero2.jpg');">
                <div class="hero-content">
                    <h1>Thưởng thức ẩm thực tuyệt vời</h1>
                    <p>Hàng trăm nhà hàng, nhiều lựa chọn</p>
                    <button class="btn btn-primary btn-lg btn-scroll" data-target="restaurantsSection">Khám phá ngay</button>
                </div>
            </div>
        </div>
        <div class="carousel-item">
            <div class="hero-banner" style="background-image: url('/images/hero3.jpg');">
                <div class="hero-content">
                    <h1>Đặt bàn dễ dàng</h1>
                    <p>Trải nghiệm tiện lợi mọi lúc</p>
                    <button class="btn btn-primary btn-lg btn-scroll" data-target="restaurantsSection">Khám phá ngay</button>
                </div>
            </div>
        </div>
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#heroCarousel" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#heroCarousel" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>

<!-- Restaurants Section -->
<div id="restaurantsSection" class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary"><i class="bi bi-shop-window me-2"></i>Danh sách nhà hàng</h2>
    </div>

    <!-- Bộ lọc -->
    <form id="filterForm" method="get" class="filter-container d-flex align-items-center mb-4">
        <div class="filter-wrapper position-relative flex-grow-1 me-2">
            <button type="button" class="scroll-btn left">
                <i class="bi bi-chevron-left"></i>
            </button>
            <div class="filter-bar d-flex flex-nowrap gap-2 px-3 align-items-center">
                <input type="text" name="search" class="form-control filter-item search-box"
                       placeholder="Tên quán..." value="@Context.Request.Query["search"]" />
                <select name="city" class="form-select filter-item select-box">
                    <option value="">Thành phố</option>
                    @foreach (var c in ViewBag.Cities)
                    {
                        <option value="@c" selected="@(Context.Request.Query["city"] == c)">@c</option>
                    }
                </select>
                <input type="text" name="address" class="form-control filter-item address-box"
                       placeholder="Địa chỉ..." value="@Context.Request.Query["address"]" />
                <select name="cuisine" class="form-select filter-item select-box">
                    <option value="">Loại món</option>
                    @foreach (var c in ViewBag.Cuisines)
                    {
                        <option value="@c" selected="@(Context.Request.Query["cuisine"] == c)">@c</option>
                    }
                </select>
                <select name="rating" class="form-select filter-item select-box">
                    <option value="">Rating</option>
                    <option value="1">1⭐+</option>
                    <option value="2">2⭐+</option>
                    <option value="3">3⭐+</option>
                    <option value="4">4⭐+</option>
                    <option value="5">5⭐</option>
                </select>
                <input type="number" name="minPrice" class="form-control filter-item price-box"
                       placeholder="Giá min" value="@Context.Request.Query["minPrice"]" />
                <input type="number" name="maxPrice" class="form-control filter-item price-box"
                       placeholder="Giá max" value="@Context.Request.Query["maxPrice"]" />
            </div>
            <button type="button" class="scroll-btn right">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <button class="btn btn-primary btn-filter" type="submit">
            <i class="bi bi-funnel"></i> Lọc
        </button>
    </form>
    @if (ViewBag.Recommendations != null && ViewBag.Recommendations.Count > 0)
    {
        <h3 class="mt-4">🔥 Gợi ý dành riêng cho bạn</h3>

        <div class="row">

            @foreach (var r in ViewBag.Recommendations)
            {
                <div class="col-lg-4 col-md-6 mb-4">

                    <div class="card border-0 shadow-lg rounded-4 h-100 hover-card">

                        <!-- Carousel hình -->
                        @{
                            var imgs = r.ImageUrl?
                            .Split(';', StringSplitOptions.RemoveEmptyEntries)
                            ?? new string[] { "/images/no-image.png" };
                            int i = 0;
                        }

                        <div id="rec-carousel-@r.Id" class="carousel slide rounded-top-4" data-bs-ride="carousel">

                            <div class="carousel-inner">

                                @foreach (var img in imgs)
                                {
                                    <div class="carousel-item @(i == 0 ? "active" : "")">
                                        <img src="@img" class="d-block w-100" style="height:180px;object-fit:cover;">
                                    </div>
                                    i++;
                                }
                            </div>
                            <button class="carousel-control-prev" data-bs-target="#rec-carousel-@r.Id" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon"></span>
                            </button>
                            <button class="carousel-control-next" data-bs-target="#rec-carousel-@r.Id" data-bs-slide="next">
                                <span class="carousel-control-next-icon"></span>
                            </button>
                        </div>


                        <div class="card-body">

                            <h5>@r.Name</h5>
                            <!-- Rating -->
                            @{
                                var reviews = r.Reviews as IEnumerable<DoAnChuyenNganh.Models.Review>;
                                var avg = (reviews != null && reviews.Any())
                                ? reviews.Average(x => x.Rating)
                                : 0;
                            }

                            <div class="mb-2">

                                @for (int star = 1; star <= 5; star++)
                                {
                                    if (star <= avg)
                                    {
                                        <i class="bi bi-star-fill text-warning"></i>
                                    }
                                    else if (star - avg < 1)
                                    {
                                        <i class="bi bi-star-half text-warning"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star text-warning"></i>
                                    }
                                }

                                <span class="text-muted">(@avg.ToString("0.0"))</span>
                            </div>
                            <p class="text-muted">@r.City</p>

                            <a class="btn btn-primary w-100"
                               href="/Home/Detail/@r.Id">Xem chi tiết</a>
                        </div>

                    </div>
                </div>
            }
        </div>
    }
    <!-- Danh sách nhà hàng -->
    <div class="row">
        @foreach (var r in Model)
        {
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card border-0 shadow-lg rounded-4 h-100 hover-card">

                    <!-- FAVORITE BUTTON -->
                    @{
                        bool isFav = ViewBag.FavoriteIds != null &&
                        ((List<int>)ViewBag.FavoriteIds).Contains(r.Id);
                    }

                    <button class="favorite-btn @(isFav ? "active" : "")" data-id="@r.Id">
                        <i class="bi @(isFav ? "bi-heart-fill" : "bi-heart")"></i>
                    </button>


                    <!-- Carousel ảnh -->
                    <div id="carousel-@r.Id" class="carousel slide rounded-top-4" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            @{
                                var images = r.ImageUrl?.Split(';', StringSplitOptions.RemoveEmptyEntries) ?? new string[] { "/images/no-image.png" };
                                int idx = 0;
                            }
                            @foreach (var img in images)
                            {
                                <div class="carousel-item @(idx == 0 ? "active" : "")">
                                    <img src="@img" class="d-block w-100 restaurant-img" alt="@r.Name" />
                                </div>
                                idx++;
                            }
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@r.Id" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon"></span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carousel-@r.Id" data-bs-slide="next">
                            <span class="carousel-control-next-icon"></span>
                        </button>
                    </div>

                    <div class="card-body">
                        <h5 class="fw-bold">@r.Name</h5>

                        <!-- Rating -->
                        @{
                            var avgRating = ViewBag.RestaurantRatings.ContainsKey(r.Id)
                            ? (double)ViewBag.RestaurantRatings[r.Id]
                            : 0;
                        }
                        <div class="mb-2">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= avgRating)
                                {
                                    <i class="bi bi-star-fill text-warning"></i>
                                }
                                else if (i - avgRating < 1)
                                {

                                    <i class="bi bi-star-half text-warning"></i>
                                }
                                else
                                {

                                    <i class="bi bi-star text-warning"></i>
                                }
                            }
                            <span class="text-muted">(@avgRating.ToString("0.0"))</span>
                        </div>

                        <p class="text-muted mb-1"><i class="bi bi-geo-alt text-danger"></i> @r.City</p>
                        <p class="mb-1"><i class="bi bi-egg-fried text-info"></i> @r.CuisineType</p>
                        <p class="fw-semibold text-success mb-3">
                            <i class="bi bi-cash-coin"></i> @r.AveragePrice.ToString("C")
                        </p>

                        <a asp-controller="Home" asp-action="Detail" asp-route-id="@r.Id"
                           class="btn btn-outline-primary w-100 btn-rounded mb-2">
                            <i class="bi bi-eye"></i> Xem chi tiết
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    /* Hero Section */
    .hero-banner {
        height: 420px;
        background-size: cover;
        background-position: center;
        display: flex;
        align-items: center;
        padding-left: 60px;
        border-radius: 12px;
    }

    .hero-content h1 {
        font-size: 42px;
        font-weight: 800;
    }

    .hero-content p {
        font-size: 18px;
        opacity: 0.9;
    }

    /* Hover Card */
    .hover-card {
        transition: .3s;
        position: relative;
    }

        .hover-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }

    /* Restaurant Image */
    .restaurant-img {
        height: 220px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
    }

    /* Favorite Button */
    .favorite-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 20;
        background: white;
        border: none;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        box-shadow: 0 4px 12px rgba(0,0,0,.15);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: .2s;
    }

        .favorite-btn i {
            font-size: 20px;
            color: #ff4b4b;
        }

        .favorite-btn:hover {
            transform: scale(1.15);
        }

    /* Filter Bar */
    .filter-wrapper {
        position: relative;
        flex-grow: 1;
        height: 50px;
        overflow: hidden;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .filter-bar {
        overflow-x: auto;
        white-space: nowrap;
        display: flex;
        align-items: center;
        height: 100%;
        padding: 0 36px;
    }

        .filter-bar::-webkit-scrollbar {
            display: none;
        }

    .scroll-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 10;
        background: rgba(255,255,255,.9);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

        .scroll-btn.left {
            left: 0;
        }

        .scroll-btn.right {
            right: 0;
        }

    .search-box {
        width: 220px;
    }

    .address-box {
        width: 180px;
    }

    .select-box {
        width: 160px;
    }

    .price-box {
        width: 120px;
    }

    .btn-filter {
        width: 120px;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Xử lý scroll của filter
    const filterBar = document.querySelector('.filter-bar');
    document.querySelector('.scroll-btn.left').onclick = () => filterBar.scrollBy({ left: -200, behavior: 'smooth' });
    document.querySelector('.scroll-btn.right').onclick = () => filterBar.scrollBy({ left: 200, behavior: 'smooth' });

    document.querySelectorAll('.btn-scroll').forEach(btn => {
        btn.addEventListener('click', e => {
            const targetId = e.currentTarget.getAttribute('data-target');
            document.getElementById(targetId).scrollIntoView({ behavior: 'smooth' });
        });
    });

        document.querySelectorAll(".favorite-btn").forEach(btn => {
        btn.addEventListener("click", function (e) {
            e.preventDefault();

            const id = this.getAttribute("data-id");
            const icon = this.querySelector("i");

            $.post("@Url.Action("ToggleFavorite", "Home")", { restaurantId: id })
                .done(res => {
                    if (res.isFavorite) {
                        this.classList.add("active");
                        icon.classList.remove("bi-heart");
                        icon.classList.add("bi-heart-fill");
                    } else {
                        this.classList.remove("active");
                        icon.classList.remove("bi-heart-fill");
                        icon.classList.add("bi-heart");
                    }
                })
                .fail(() => {
                    console.log("Lỗi AJAX: Có thể bạn chưa đăng nhập!");
                });
        });
    });
</script>