@model IEnumerable<DoAnChuyenNganh.Models.Notification>

@{
    ViewData["Title"] = "Thông báo";
}

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<!-- Animate.css -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

<!-- AOS (scroll animations) -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

<style>
    .notification-card {
        border-left: 4px solid #0d6efd;
        transition: 0.25s ease;
        border-radius: 12px;
        padding: 18px;
        background: #fff;
    }

        .notification-card:hover {
            transform: translateX(6px);
            background: #f8f9fa;
        }

        .notification-card.read {
            border-left: 4px solid #6c757d !important; /* xám nhẹ */
            background: #fff !important;
            opacity: 0.9;
        }

    .notification-badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 10px;
    }

    .message-text {
        font-size: 15px;
        line-height: 1.5;
    }

    .notification-header {
        font-size: 16px;
        font-weight: 600;
    }

    .empty-box {
        text-align: center;
        padding: 50px;
        border-radius: 20px;
        background: #f8f9fa;
    }
</style>

<div class="container py-4">

    <h2 class="mb-4 animate__animated animate__fadeInDown">
        <i class="bi bi-bell-fill text-primary"></i> Thông báo
    </h2>

    <div class="d-flex justify-content-between mb-3 animate__animated animate__fadeInUp">
        <span class="text-muted">Bạn có @Model.Count() thông báo</span>

        <div>
            <button id="deleteAllBtn" class="btn btn-outline-danger btn-sm me-2">
                <i class="bi bi-trash"></i> Xóa toàn bộ
            </button>

            <button id="markAllReadBtn" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-check2-all"></i> Đánh dấu tất cả là đã đọc
            </button>
        </div>
    </div>

    <div class="list-group gap-2">

        @if (!Model.Any())
        {
            <div class="empty-box animate__animated animate__fadeIn">
                <i class="bi bi-inbox text-secondary" style="font-size: 50px;"></i>
                <p class="mt-3 text-muted">Không có thông báo nào.</p>
            </div>
        }

        @foreach (var item in Model)
        {
            <div class="notification-card shadow-sm"
                 data-aos="fade-up"
                 data-aos-duration="500">

                <div class="d-flex justify-content-between">
                    <div>
                        <div class="notification-header">
                            @Html.Raw(
                            item.Type == "System"
                            ? "<i class='bi bi-exclamation-circle text-primary'></i> Thông báo hệ thống"
                            : "<i class='bi bi-chat-left-text text-success'></i> Tin nhắn")
                        </div>

                        <div class="message-text mt-1">
                            @item.Message
                        </div>

                        <small class="text-muted">
                            <i class="bi bi-clock"></i> @item.CreatedAt.ToString("HH:mm dd/MM/yyyy")
                        </small>
                    </div>

                    @if (!item.IsRead)
                    {
                        <span class="notification-badge bg-primary text-white align-self-start">Mới</span>
                    }
                </div>
            </div>
        }
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
    // Khởi tạo AOS
    AOS.init();

    const markAllReadBtn = document.getElementById("markAllReadBtn");
    const deleteAllBtn = document.getElementById("deleteAllBtn");

    // 🔹 Đánh dấu tất cả thông báo là đã đọc
    markAllReadBtn.addEventListener("click", function () {
        axios.post('/Account/MarkAllNotificationsRead')
            .then(response => {
                if (response.data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Đã cập nhật!',
                        text: 'Tất cả thông báo đã được đánh dấu là đã đọc.',
                        timer: 1200,
                        showConfirmButton: false
                    });

                    // Cập nhật tất cả thẻ thông báo
                    document.querySelectorAll(".notification-card").forEach(card => {
                        // Xóa badge "Mới"
                        const badge = card.querySelector(".notification-badge");
                        if (badge) badge.remove();

                        // Thêm class read để style xám nhẹ
                        card.classList.add("read", "animate__animated", "animate__fadeIn");
                    });

                    // Xóa badge đỏ trên icon chuông nếu có
                    const bellBadge = document.querySelector("#bellBadge");
                    if (bellBadge) bellBadge.remove();

                    // Cập nhật số lượng thông báo mới
                    const countText = document.querySelector("span.text-muted");
                    if (countText) countText.textContent = `Bạn có 0 thông báo mới`;
                }
            })
            .catch(() => {
                Swal.fire('Lỗi', 'Không thể cập nhật thông báo!', 'error');
            });
    });

    // 🔹 Xóa tất cả thông báo
        deleteAllBtn.addEventListener("click", function () {
        const notifications = document.querySelectorAll(".notification-card");

        if (notifications.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Chưa có thông báo',
                text: 'Bạn chưa có thông báo nào để xóa.',
                timer: 1500,
                showConfirmButton: false
            });
            return; // Không làm gì nữa
        }

        Swal.fire({
            title: "Bạn chắc chắn?",
            text: "Tất cả thông báo sẽ bị xóa vĩnh viễn.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Xóa",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#d33"
        }).then(result => {
            if (result.isConfirmed) {
                axios.post('/Account/DeleteAllNotifications')
                    .then(response => {
                        if (response.data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Đã xóa!',
                                text: 'Tất cả thông báo đã bị xóa.',
                                timer: 1500,
                                showConfirmButton: false
                            });

                            // Xóa tất cả thẻ thông báo
                            notifications.forEach(card => card.remove());

                            // Xóa tất cả badge đỏ
                            document.querySelectorAll(".notification-badge").forEach(badge => badge.remove());

                            // Cập nhật số lượng thông báo
                            const countText = document.querySelector("span.text-muted");
                            if (countText) countText.textContent = "Bạn có 0 thông báo";

                            // Thêm box "Không có thông báo"
                            const listGroup = document.querySelector(".list-group");
                            if (listGroup) {
                                const emptyBox = document.createElement("div");
                                emptyBox.classList.add("empty-box", "animate__animated", "animate__fadeIn");
                                emptyBox.innerHTML = `
                                    <i class="bi bi-inbox text-secondary" style="font-size: 50px;"></i>
                                    <p class="mt-3 text-muted">Không có thông báo nào.</p>
                                `;
                                listGroup.appendChild(emptyBox);
                            }
                        }
                    })
                    .catch(() => {
                        Swal.fire('Lỗi', 'Không thể xóa thông báo!', 'error');
                    });
            }
        });
    });
</script>

