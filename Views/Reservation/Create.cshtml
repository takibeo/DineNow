@model DoAnChuyenNganh.Models.Reservation

@{
    ViewData["Title"] = "Đặt bàn";
    var restaurants = ViewBag.Restaurants as List<DoAnChuyenNganh.Models.Restaurant>;
    var restaurant = restaurants?.FirstOrDefault(r => r.Id == Model.RestaurantId);
}

<!-- SweetAlert2 -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
            <h2 class="mb-4 text-center text-primary">🪑 Đặt bàn nhà hàng</h2>

            <form asp-action="Create" method="post" id="reservationForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                @if (Model.RestaurantId > 0)
                {
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nhà hàng</label>
                        <input type="hidden" asp-for="RestaurantId" />
                        <input type="text" class="form-control" value="@restaurant?.Name" readonly />
                    </div>
                }
                else
                {
                    <div class="mb-3">
                        <label asp-for="RestaurantId" class="form-label fw-bold">Chọn nhà hàng</label>
                        <select asp-for="RestaurantId" class="form-select" asp-items="@(new SelectList(ViewBag.Restaurants, "Id", "Name"))">
                            <option value="">-- Chọn nhà hàng --</option>
                        </select>
                        <span asp-validation-for="RestaurantId" class="text-danger"></span>
                    </div>
                }

                <div class="mb-3">
                    <label class="form-label fw-bold">Ngày đặt</label>
                    <input type="text" id="dateInput" class="form-control" placeholder="Chọn ngày..." required readonly style="cursor:pointer;" />
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Giờ đặt (24h)</label>
                    <select id="timeDropdown" class="form-select" required>
                        <option value="">-- Chọn giờ --</option>
                    </select>
                </div>

                <input type="hidden" asp-for="ReservationDate" id="ReservationDate" />
                <span asp-validation-for="ReservationDate" class="text-danger"></span>

                <div class="mb-3">
                    <label asp-for="NumberOfGuests" class="form-label fw-bold">Số lượng khách</label>
                    <input asp-for="NumberOfGuests" type="number" min="1" class="form-control" />
                    <span asp-validation-for="NumberOfGuests" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="ContactPhone" class="form-label fw-bold">Số điện thoại liên hệ</label>
                    <input asp-for="ContactPhone" class="form-control" placeholder="Nhập số điện thoại của bạn" />
                    <span asp-validation-for="ContactPhone" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Note" class="form-label fw-bold">Ghi chú (tuỳ chọn)</label>
                    <textarea asp-for="Note" class="form-control" rows="3" placeholder="Ví dụ: Gần cửa sổ, có ghế trẻ em..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">
                    <i class="bi bi-calendar-check"></i> Đặt bàn ngay
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const dateInput = document.getElementById("dateInput");
            const timeDropdown = document.getElementById("timeDropdown");
            const hiddenDate = document.getElementById("ReservationDate");
            const form = document.getElementById("reservationForm");

            // Flatpickr cho ngày
            flatpickr("#dateInput", {
                dateFormat: "Y-m-d",
                minDate: "today",
                allowInput: false,
                disableMobile: true,
            });

            // Hàm sinh các option giờ
            function populateTimeDropdown(minHour = 8, maxHour = 20, increment = 30) {
                timeDropdown.innerHTML = '<option value="">-- Chọn giờ --</option>';
                for (let h = minHour; h <= maxHour; h++) {
                    for (let m = 0; m < 60; m += increment) {
                        if (h === maxHour && m > 0) continue;
                        const option = document.createElement('option');
                        const hh = String(h).padStart(2, '0');
                        const mm = String(m).padStart(2, '0');
                        option.value = `${hh}:${mm}`;
                        option.text = `${hh}:${mm}`;
                        timeDropdown.appendChild(option);
                    }
                }
            }

            populateTimeDropdown();

            // Cập nhật hidden input khi chọn giờ
            function updateHiddenDate() {
                if (dateInput.value && timeDropdown.value) {
                    hiddenDate.value = `${dateInput.value}T${timeDropdown.value}`;
                } else {
                    hiddenDate.value = '';
                }
            }

            timeDropdown.addEventListener("change", updateHiddenDate);

            // Chặn chọn giờ đã trôi qua hôm nay
            dateInput.addEventListener("change", function () {
                const selectedDate = new Date(dateInput.value);
                const today = new Date();
                let minHour = 8;
                let minMinute = 0;

                if (selectedDate.toDateString() === today.toDateString()) {
                    minHour = today.getHours();
                    minMinute = today.getMinutes() < 30 ? 30 : 0;
                }

                for (let opt of timeDropdown.options) {
                    if (!opt.value) continue;
                    const [h, m] = opt.value.split(':').map(Number);
                    if (h < minHour || (h === minHour && m < minMinute)) {
                        opt.disabled = true;
                    } else {
                        opt.disabled = false;
                    }
                }

                updateHiddenDate();
            });

            // SweetAlert2 xác nhận trước khi submit
            form.addEventListener("submit", function (e) {
                e.preventDefault();
                updateHiddenDate();

                Swal.fire({
                    title: "Xác nhận đặt bàn?",
                    text: "Bạn có chắc muốn đặt bàn với thông tin này không?",
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Đặt ngay",
                    cancelButtonText: "Kiểm tra lại",
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#6c757d"
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = new FormData(form);
                        fetch(form.action, {
                            method: "POST",
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    title: "🎉 Thành công!",
                                    text: data.message || "Đặt bàn thành công!",
                                    icon: "success",
                                    confirmButtonText: "OK",
                                    confirmButtonColor: "#3085d6"
                                }).then(() => {
                                    window.location.href = '@Url.Action("MyReservations", "Reservation")';
                                });
                            } else {
                                Swal.fire("Lỗi!", data.message || "Không thể đặt bàn, vui lòng thử lại!", "error");
                            }
                        })
                        .catch(() => {
                            Swal.fire("Lỗi!", "Không thể gửi yêu cầu, vui lòng thử lại!", "error");
                        });
                    }
                });
            });
        });
    </script>
}
