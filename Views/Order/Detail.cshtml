@model DoAnChuyenNganh.Models.ViewModels.OrderDetailViewModel

@{
    ViewData["Title"] = "Chi tiết đơn hàng";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<div class="container mt-4">

    <h2 class="text-center mb-4 text-primary">
        <i class="bi bi-card-checklist me-2"></i>@ViewData["Title"]
    </h2>

    <!-- Thông tin đơn hàng -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <p><strong>Nhà hàng:</strong> @Model.Order.Restaurant?.Name</p>
            <p><strong>Ngày tạo:</strong> @Model.Order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
            <p><strong>Trạng thái:</strong> <span class="badge bg-@(Model.Order.Status == "Pending" ? "warning" : "success")">@Model.Order.Status</span></p>
            <p><strong>Phương thức thanh toán:</strong> @(Model.Order.PaymentMethod ?? "Chưa chọn")</p>
        </div>
    </div>

    <!-- Danh sách món ăn -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-basket3 me-2"></i>Chi tiết món ăn
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Hình ảnh</th>
                        <th>Tên món</th>
                        <th>Giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Order.Items)
                    {
                        <tr>
                            <td>
                                <img src="@(item.MenuItem?.ImageUrl ?? "/images/no-image.png")"
                                     alt="@item.MenuItem?.Name"
                                     style="width:60px; height:60px; object-fit:cover;"
                                     class="rounded" />
                            </td>
                            <td>@item.MenuItem?.Name</td>
                            <td>@item.Price.ToString("N0") đ</td>
                            <td>@item.Quantity</td>
                            <td>@((item.Price * item.Quantity).ToString("N0")) đ</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer text-end fw-bold">
            Tổng tiền: <span class="text-danger">@Model.Order.TotalAmount.ToString("N0") đ</span>
        </div>
    </div>

    <!-- Thông tin giao hàng & thanh toán -->
    @if (Model.Order.Status == "Pending" && Model.Order.PaymentMethod == null)
    {
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-geo-alt-fill me-2"></i>Thông tin giao hàng
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Địa chỉ giao hàng</label>
                            <input type="text" id="deliveryAddress" class="form-control" placeholder="Nhập địa chỉ..." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" id="phoneNumber" class="form-control" placeholder="Nhập số điện thoại..." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ghi chú</label>
                            <textarea id="note" class="form-control" placeholder="Ghi chú cho nhà hàng..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-cash-stack me-2"></i>Thanh toán
                    </div>
                    <div class="card-body d-flex flex-column align-items-center justify-content-center">
                        <form asp-action="PayCash" method="post" class="w-100 mb-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="orderId" value="@Model.Order.Id" />
                            <button type="submit" id="cashBtn" class="btn btn-lg btn-success w-100" disabled>
                                <i class="bi bi-cash me-2"></i>Thanh toán tiền mặt
                            </button>
                        </form>

                        <form asp-action="PayVnPay" method="post" class="w-100">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="orderId" value="@Model.Order.Id" />
                            <button type="submit" id="vnPayBtn" class="btn btn-lg btn-danger w-100" disabled>
                                <i class="bi bi-credit-card me-2"></i>Thanh toán VNPAY
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-success text-center mt-3">
            <i class="bi bi-check-circle-fill me-2"></i>Đơn hàng đã được đặt thành công.
        </div>
    }
</div>

@section Scripts {
    <script>
        const addressInput = document.getElementById("deliveryAddress");
        const phoneInput = document.getElementById("phoneNumber");
        const cashBtn = document.getElementById("cashBtn");
        const vnPayBtn = document.getElementById("vnPayBtn");

        function checkEnablePayment() {
            const address = addressInput.value.trim();
            const phone = phoneInput.value.trim();
            const enable = address !== "" && phone !== "";
            cashBtn.disabled = !enable;
            vnPayBtn.disabled = !enable;
        }

        addressInput?.addEventListener("input", checkEnablePayment);
        phoneInput?.addEventListener("input", checkEnablePayment);
    </script>
}
